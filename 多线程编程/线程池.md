# 线程池

**为什么需要线程池**

单核时代：

如果是纯运算的操作是不需要多线程的，一个线程一直运算即可。

但是这个线程正在等待io操作的话， 那么此时的CPU处于空闲状态。

此时的多线程是为了提高CPU的利用率而提出的

多核时代：

能够同时运行的线程数也提升了 ==> 提高CPU的利用率 + 充分利用每个核心

CPU的核心数有限 ==> 同时运行的线程数有限，根据调度算法切换执行的线程，线程之间的切换需要开销 （替换寄存器的内容，高速缓存失效）

线程数太多 ==> 切换的频率就会变高 ==> 多线程带来的好处敌不过线程切换带来的开销

线程数的数量与CPU的核心数和I/O 等待时长有关

**什么是线程池**

评估系统所要承载的并发量 和 执行任务的特性 ==> 控制线程数量

线程的创建和销毁很耗费资源，所以我们需要避免线程频繁的创建和销毁，因此我们需要缓存一批线程，让它们时刻准备执行任务。

目标已经很清晰了，弄一个池子，里面存放约定数量的线程，这就是线程池，一种池化技术。

**线程池的组成部分**

线程池主要是由三个部分组成，这三个部分配合工作就可以得到一个完整的线程池

大部分并发问题都可以用生产者消费者模型来解决

- 任务队列，存储需要处理的任务，由工作的线程来处理这些任务（生产者将任务放入任务队列里面）
  
  - 通过线程池提供的API，将一个待处理的任务添加到任务队列中，或者从任务队列中删除
  
  - 已处理的任务会从任务队列中删除
  
  - 线程池的使用者，也就是调用线程池的函数往任务队列中添加任务的线程就是生产者线程
  
  线程池里的任务都是处理动作，处理流程基于函数实现，任务队列中的任务都是函数，也就是存放的都是函数的地址。

- 工作线程（任  务队列任务的消费者）N个
  
  - 线程池中维护了一定数量的工作线程，它们的作用是不停的读取任务队列，从里面取出任务并处理
  
  - 工作的线程相当于任务队列的消费者角色
  
  - 如果阻塞之后有了新的任务，由生产者将阻塞解除，工作线程开始工作

- 管理者线程（不处理任务队列中的任务）1个
  
   他的任务是周期性的对任务队列中的任务数量以及忙于状态的工作线程个数进行检测
  
  - 当任务过多的时候，可以适当的创建一些新的工作线程
  
  - 当任务国少的时候，可以适当的销毁一些工作的线程
